<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>OpenStack Cloud Maker - Cluster Configuration & Deployment</title>
<link rel="stylesheet" href="css/jquery-ui.css">
<link rel="stylesheet" href="css/tab_style.css">
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/bootstrap-editable.css">

 <script src="http://localhost:5984/_utils/script/jquery.js?1.4.2"></script>	
 <script src="http://localhost:5984/_utils/cloud_maker/js/jquery-ui.js"></script>	
 <script src="http://localhost:5984/_utils/script/jquery.couch.js?0.11.0"></script>	

  <script>
  $(function() {
    $( "#tabs" ).tabs().addClass( "ui-tabs-vertical ui-helper-clearfix" );
    $( "#tabs li" ).removeClass( "ui-corner-top" ).addClass( "ui-corner-left" );
  });
  </script>
  

  
  
  <script>
  
  var cloud_nodes;
  var chef_roles;
  
  var isNew=true;
  var currentID;
  
  var loadedBaseObject;
  var loadedHAObject;
  var loadedNodesObj ={};	
  
  $(document).ready(function() {
  

		setTimeout(function() {chooseNodeMappingOptions(); }, 2000);		
 
				loadClusterList();
				loadAllNodes();
			
					// fetch nodes
				$.couch.db("devops").view("node-query/all", {
					success: function(data) {					
						cloud_nodes = data;		
						console.log("cloud_nodes : " + cloud_nodes);								
					},
					error: function(status) {
						console.log("Error in node-query/all : " + status);		
					},
					reduce: false
				});	
				

				$.couch.db("devops").view("chef-roles-query/all", {
					success: function(data) {
					
						chef_roles = data;		
						console.log("chef_roles : " + chef_roles);		
						
					},
					error: function(status) {
						console.log("Error in chef-roles-query/all : " + status);		
					},
					reduce: false
				});	
					  
					  
	$('#tabs').tabs({ active: 0 });

	setTimeout(function() {clearAll(); }, 2000);	
	
	$('#HAConfigurataion input:checkbox').change(function () {

		if(this.checked)
		{
			$('#row'+this.name).show();
			$('#'+this.name+"text").focus();
		}
		else
		{
			$('#row'+this.name).hide();	
		}
		
	});
	 $('#tabs-3 input:radio').change(function () {
			var selectedVal = $("#tabs-3 input:radio:checked").val();

			if(selectedVal=="New")
			{
				isNew=true;
				$("#selectOptionLabel").text("Create New Node");
				$('.newCluster').show();
				$('.existingNode').hide();
				
			}
			else
			{
				isNew=false;
				$("#selectOptionLabel").text("Please Choose Node");
				$('.newCluster').hide();
				$('.existingNode').show();
				loadClusterConfiguration();
			}	
		
	 });
	 
	 $('#existingNodeSelect').change(function () {
			loadClusterConfiguration();
	 });
	 
	 
	 $('#networktype').change(function () {
		chooseNodeMappingOptions();
	  });

	 $('#deploymentSelectionSelect').change(function () {		
			chooseNodeMappingOptions();
	  });
	  

	 $(".nextButton").click(function(e){
			
		var currentTabIndex = $("#tabs").tabs("option", "active");
		console.log("currentTabIndex : " + currentTabIndex);
		
		if(currentTabIndex !=6)
		{
			$("#tabs").tabs("option", "active", currentTabIndex+1);
		}
	 
	 });
	 
	 $(".backButton").click(function(e){
			
		var currentTabIndex = $("#tabs").tabs("option", "active");
		console.log("currentTabIndex : " + currentTabIndex);
		
		if(currentTabIndex !=2)
		{
			$("#tabs").tabs("option", "active", currentTabIndex-1);
		}
	 
	 });	 
	 
	 
	 
	  $("#resetCluster").click(function(e){
			clearAll();
	 });
	 
	 $("#haEnabledCheck").click(function(e){
			chooseNodeMappingOptions();
	 });
	 
	 
	 $("#startDeployment").click(function(e){
		
			// Save Info Tab
		console.log("isNew : "+ isNew);	
		if(isNew)
		{
			var jsonPayload = {};
			jsonPayload['type']='cluster';
			
			jsonPayload['ssh_key']='/root/.ssh/id_rsa';
			jsonPayload['user_name']='root';
			jsonPayload['chef_path']='/root/openstackchef/openstack-installation';
			jsonPayload['chef_env_name']=$("#name").val();
			jsonPayload['chef_server_ip']='172.16.0.8';
			
			var rows = $('#newCluster input:text');
			for(i=0;i<rows.length;i++)
			{
				jsonPayload[rows[i].name]=rows[i].value;
			}
			
			var docID;
			$.couch.db("devops").saveDoc(jsonPayload, {
				success: function(data) {
					if(data.ok)
					{
						docID = data.id;
						console.log("ID : " +docID);
						startTabSave(docID);
					}
				},
				error: function(status) {
					console.log("Error in saving cluser " + status);
				}
			});
		}
		else
		{
			console.log("currentID : "+ currentID);	
			if(currentID !=null)
			{	
				
				// Update Basic Object
				var basicObject1 = saveBasicConfigurationNew(currentID);	
			
				basicObject1['_id'] = loadedBaseObject['_id'];
				basicObject1['_rev'] = loadedBaseObject['_rev'];
				basicObject1['cluster_name'] = loadedBaseObject['cluster_name'];
				
				$.couch.db("devops").saveDoc(basicObject1, {
					success: function(data) {
						//console.log(data.rev);
						loadedBaseObject['_rev'] = data.rev;
					},
					error: function(status) {
						console.log("Error in Basic Configuration Save : " +status);
					}
				});
				
				console.log("Basic Configuration Saved");
				// Update HA Object
				
				
				var haEnabledCheck = $('input:checkbox[name=haEnabledCheck]:checked').val();
			
				var haObject1;
				
				if(haEnabledCheck)
				{
					haObject1 = saveHAConfigurationNew(currentID);	
					haObject1['cluster_name'] = loadedBaseObject['cluster_name'];
				}
				
				console.log("loadedHAObject : "+ loadedHAObject);
				console.log("haObject1 : "+ haObject1);
				
				if(loadedHAObject)
				{
					//console.log("loadedHAObject['_id'] " + loadedHAObject['_id']);
					haObject1['_id'] = loadedHAObject['_id'];
					haObject1['_rev'] = loadedHAObject['_rev'];
				}
				else
				{		
					//console.log("no present....New entry");
					
				}
					
				if(haEnabledCheck)
				{			
					console.log("Saving HA Object");	
					$.couch.db("devops").saveDoc(haObject1, {
						success: function(data) {
							//console.log(data.rev);
							if(!loadedHAObject)
							{
								loadedHAObject=haObject1;
							}
							loadedHAObject['_rev'] = data.rev;
						},
						error: function(status) {
							console.log("Error in HA Save : " +status);
						}
					});				
				
				}
				else
				{
					if(haObject1)
					{
						console.log("Removing HA Object");
						$.couch.db("devops").removeDoc(haObject1, {
							success: function(data) {
								//console.log(data.rev);
								loadedHAObject="";
							},
							error: function(status) {
								console.log("Error in HA removal : " +status);
							}
						});										
					}
				}
				console.log("HA Configuration Saved");
				
				// Save Node Role Mapping
							
				var rows = $('#NodeMappingTable tr');
				rows.each(function() {
					
					var nodeID=this.id;
					console.log("nodeID : " + nodeID);
					//console.log(nodeID);
					//console.log(loadedNodesObj[nodeID]);
					
					var oldnodeRoleObject1=loadedNodesObj[nodeID];
					
					console.log("oldnodeRoleObject1 : " + oldnodeRoleObject1);
					
					var nodeRoleObject1 = saveNodeRoleMappingNew(currentID,nodeID);
					
					//cloudObj.push(nodeRoleObject);	
					
					console.log("nodeRoleObject1 : " + nodeRoleObject1);
					
					if(nodeRoleObject1)
					{					
						if(oldnodeRoleObject1)
						{
							nodeRoleObject1['_id'] = oldnodeRoleObject1['_id'];
							nodeRoleObject1['_rev'] = oldnodeRoleObject1['_rev'];
						}
						
						nodeRoleObject1['cluster_name'] = loadedBaseObject['cluster_name'];
					
						$.couch.db("devops").saveDoc(nodeRoleObject1, {
							success: function(data) {
								//console.log(data.rev);
								oldnodeRoleObject1['_rev'] = data.rev;							
								loadedNodesObj[nodeID]=oldnodeRoleObject1;
							},
							error: function(status) {
								console.log("Error in Node Role Saving : " +status);
							}
						});					
					}
					else
					{					
						console.log("Removing Node Role Mapping : "+ nodeID);
						
						if(oldnodeRoleObject1)
						{
							$.couch.db("devops").removeDoc(oldnodeRoleObject1, {
								success: function(data) {
									//console.log(data.rev);
									delete loadedNodesObj[nodeID];
								},
								error: function(status) {
									console.log("Error in Node Role Mapping removal : " +status);
								}
							});						
						}	
						
					}
					
				});
				
				console.log("Node Role Mapping Saved");
				
				// Start Deployment
				
				startDeployment(loadedBaseObject['cluster_name']);
				
				
			}
		}
			
	  });
	  
	  	  
	  
	  function startTabSave(docID)
	  {

			if(docID !=null)
			{
				var cloudObj = [];

				var basicObject = saveBasicConfigurationNew(docID);		
				cloudObj.push(basicObject);
				
				var haEnabledCheck = $('input:checkbox[name=haEnabledCheck]:checked').val();
				if(haEnabledCheck)
				{
					var haObject = saveHAConfigurationNew(docID);	
					cloudObj.push(haObject);					
				}	
				
				var rows = $('#NodeMappingTable tr');
				rows.each(function() {
					var nodeRoleObject = saveNodeRoleMappingNew(docID,this.id);
					
					console.log("nodeRoleObject " + nodeRoleObject);
					
					if(nodeRoleObject!="")
					{
						cloudObj.push(nodeRoleObject);	
					}
				});
						
				$.couch.db("devops").bulkSave({"docs": cloudObj}, {
					success: function(data) {
						startDeployment($("#name").val());
					},
					error: function(status) {
						console.log(status);
					}
				});
					
				
			}
	  }
	  
	   function saveNodeRoleMappingNew(id,rowid) {
 
		var nodeName = rowid;
		var rows1 = $("#"+(rowid)+" input:checkbox");
			//alert(rows1.length);
			
		var jsonPayload = {};
		jsonPayload['type']='node-role-mapping';
		jsonPayload['clusterid']=id;
		jsonPayload['cluster_name']=$("#name").val();			
		jsonPayload['hostname']=nodeName;
		
		var rolePayload = new Array();
		
		console.log("rows1.length " + rows1.length);
		

			for(i=0;i<rows1.length;i++)
			{
				var isEnabledCheck = $('input:checkbox[name='+(rows1[i].name)+']:checked').val();
				if(isEnabledCheck)
				{
					rolePayload.push(rows1[i].value);
				}				
			}			
			console.log("rolePayload : " + rolePayload);
			console.log("rolePayload.size : " + rolePayload.size);
			if(rolePayload!="")
			{			
				jsonPayload['role']=rolePayload;						
				return jsonPayload;
			}
			else
			{
				return "";
			}
  }
	  
	   function saveHAConfigurationNew(id) {
 
		//alert(id);
	
		var jsonPayload = {};
		jsonPayload['type']='cluster-ha-setting';
		jsonPayload['clusterid']=id;
		jsonPayload['cluster_name']=$("#name").val();

			var rows = $('#loadBalancer select');
			for(i=0;i<rows .length;i++)
			{
				jsonPayload[rows[i].name]=rows[i].value;
			}		

			var rows = $('#HAConfigurataion input:checkbox');
			//alert(rows.length);
			
			var haPayload = {};
			var vipsPayload = {};
			
			for(i=0;i<rows.length;i++)
			{
				var isEnabledCheck = $('input:checkbox[name='+(rows[i].name)+']:checked').val();
				if(isEnabledCheck)
				{
					haPayload[rows[i].name+"_ha"]=isEnabledCheck;
					vipsPayload[rows[i].name+"_vip"]=$("#"+rows[i].name+"text").val();
					
					if(rows[i].name=='db')
					{
						var dbPayload = {};
						dbPayload['db2_primary_host']=$("#dbtext1").val();
						dbPayload['db2_standby_host']=$("#dbtext2").val();
						
						jsonPayload['db']=dbPayload;
					}
					
					if(rows[i].name=='mq')
					{
						var mqPayload = {};
						mqPayload['qpid_nodes']=$("#mqtext1").val()+","+$("#mqtext2").val();
						
						jsonPayload['mq']=mqPayload;
					}					
				}
				else
				{
					haPayload[rows[i].name+"_ha"]='false';
					vipsPayload[rows[i].name+"_vip"]="0.0.0.0";
				}
			}				
						
			jsonPayload['ha']=haPayload;
			jsonPayload['vips']=vipsPayload;
			
			return jsonPayload;

    }
	  
	   function saveBasicConfigurationNew(id) {
 

		var jsonPayload = {};
		jsonPayload['type']='cluster-basic-setting';
		jsonPayload['clusterid']=id;
		//console.log("name : " + $("#name").val());
		jsonPayload['cluster_name']=$("#name").val();


		var rows = $('#basicConfiguration select');
		for(i=0;i<rows .length;i++)
		{
			jsonPayload[rows[i].name]=rows[i].value;
		}

		if($("#networktype").val() == 'quantum')
		{
		
			var quantumPayload = {};			
			var rows = $('#Quantum input:text');

			for(i=0;i<rows .length;i++)
			{
				quantumPayload[rows[i].name]=rows[i].value;
			}
	
			var rows = $('#Quantum input:radio');

			for(i=0;i<rows .length;i++)
			{
				quantumPayload[rows[i].name]=rows[i].value;
			}
			
			jsonPayload['quantum']=quantumPayload;
		}

		
		var networksPayload = {};
		
		var rows = $('#OSOPS input:text');

		for(i=0;i<rows .length;i++)
		{
			networksPayload[rows[i].name]=rows[i].value;
		}
		
		networksPayload['dns1']="172.16.0.1";
		networksPayload['bridge']="br-vmnet";
		networksPayload['bridgedev']="eth1";
		networksPayload['vmnet']="192.168.1.0/24";
		networksPayload['vmnetnum']="1";
		networksPayload['vmnetsize']="256";
		networksPayload['firewall_driver']="nova.virt.firewall.NoopFirewallDriver";
		networksPayload['network_manager']="nova.network.manager.FlatDHCPManager";
		
		var vlanPayload = {};
		vlanPayload['vlan_start']="520";
		vlanPayload['vlan_end']="550";
		vlanPayload['vlan_interface']="vlan1";
		networksPayload['vlan']=vlanPayload;
		
		jsonPayload['networks']=networksPayload;
		
				
		var glancePayload = {};
		var image_upload = $('input:radio[name=image_upload]:checked').val();
		glancePayload['image_upload']=image_upload;		
		jsonPayload['glance']=glancePayload;

		var gpfsPayload = {};
		gpfsPayload['gpfs_cluster_name']="gpfs_01";
		jsonPayload['gpfs']=gpfsPayload;
		
		jsonPayload['enable_iptables']='true';
		jsonPayload['packageserver']="172.16.0.8";
		jsonPayload['imageserver']="172.16.0.8";
	
		return jsonPayload;
		
    }
	  
 
  });	
	
	function startDeployment(cluster_name)
	  {
		// Save Info Tab
		var jsonPayload = {};
		jsonPayload['type']='action';
		
		jsonPayload['status']='start'; //Four status: start, running, end, failed
		jsonPayload['cluster_name']=cluster_name;
		jsonPayload['user_name']='root';
		
		var rows = $('#newCluster input:text');
		for(i=0;i<rows.length;i++)
		{
			jsonPayload[rows[i].name]=rows[i].value;
		}
		

		$.couch.db("devops").saveDoc(jsonPayload, {
			success: function(data) {
				if(data.ok)
				{
					console.log("action : " + data.rev);
					alert("Deployment request sent!");
					clearAll();
					showDeploymentLogs();
					loadClusterList();
				}
			},
			error: function(status) {
			console.log("Error in Deployment request " + status);
			}
		});
			
	  }

	function showDeploymentLogs()
	  {

	
		setInterval(function() {
		  
		  $.ajax({type:'GET', 
				  url: 'http://172.16.0.8:5984/devops/logid12345/install.log',     		
				  success: function(response) { 
				  // alert(response);
				  if(response)
				  {	
					//$('#result').append("\n"+response);
					$('#result').val("\n"+response);
					tailScroll();
				  }
			 },
			 error: function(jqXHR, textStatus, errorThrown) {
		  		// alert("Some Error has occurred.");
			 }   			 
			 }); 

			
		}, 10000 );
	  }
	  
    
	  function tailScroll() {
		  var height = $("#result").get(0).scrollHeight;
		  $("#result").animate({
			  scrollTop: height
		  }, 500);
	  }
	  
	
	function loadClusterConfiguration()
	{
	
		var currentCluster = $("#existingNodeSelect").val();
		currentID = currentCluster;
		//alert(currentCluster);	
		$.couch.db("devops").view("data/by_clusterid", { key: currentCluster, success: function(data) {

					var nodes = data.rows;
	
					for(nodeI=0;nodeI<nodes.length;nodeI++)
					{
						var jsonObject = nodes[nodeI];
						//alert(jsonObject);
						var jsonValue = jsonObject.value;
						
						//alert(jsonValue.type);
						if(jsonValue.type == "cluster-basic-setting")
						{
							loadedBaseObject = jsonValue;
							var rows = $('#basicConfiguration select');
							for(i=0;i<rows.length;i++)
							{
								$('#'+(rows[i].name)).val(jsonValue[rows[i].name]);
								
								if(jsonValue[rows[i].name] =="quantum")
								{
									$('.Quantum').show();		
									var quantumObj = jsonValue['quantum'];
									
									var input_rows = $('#Quantum input:text');
									for(j=0;j<input_rows.length;j++)
									{
										$('#'+(input_rows[j].name)).val(quantumObj[input_rows[j].name]);
									}
									
									//alert(quantumObj['enable_tunneling']);
									if(quantumObj['enable_tunneling'] == 'true')
									{
										$('input:radio[name=enable_tunneling]:nth(0)').attr('checked',true);
									}
									else
									{
										$('input:radio[name=enable_tunneling]:nth(1)').attr('checked',true);
									}
									
								}
								else
								{
									$('.Quantum').hide();	
								}															
							}
						
							var networksObj = jsonValue['networks'];
							
							var rows = $('#OSOPS input:text');

							for(k=0;k<rows.length;k++)
							{
								$('#'+(rows[k].name)).val(networksObj[rows[k].name]);
							}								
							
							var glanceOjb = jsonValue['glance'];
							
							if(glanceOjb['image_upload'] == 'true')
							{
								$('input:radio[name=image_upload]:nth(0)').attr('checked',true);
							}
							else
							{
								$('input:radio[name=image_upload]:nth(1)').attr('checked',true);
							}							
							
						}
						else if(jsonValue.type == "cluster-ha-setting")
						{
							loadedHAObject=jsonValue;
							
							$('#haEnabledCheck').attr('checked', 'checked');							
							$('.loadBalancer').show();	

							chooseNodeMappingOptions();
							//console.log("Proceeding");

							$('#hatype').val(jsonValue['hatype']);
							
							var haObj = jsonValue['ha'];
							var vipsObj = jsonValue['vips'];

							var all_keys = Object.keys(haObj);
													
							for (var j in all_keys) {
								var value = haObj[all_keys[j]];
								//alert(value);
								
								if(value == 'true')
								{									
									//alert(all_keys[j].indexOf("_ha"));
									
									var objName = 	all_keys[j].substr(0,all_keys[j].indexOf("_ha"));
									//alert(objName);									
									$('#'+objName+'').attr('checked', 'checked');
									$('#row'+objName).show();

									$('#'+(objName)+'text').val(vipsObj[objName+"_vip"]);
									
									if(objName=="db")
									{
										var dbObj = jsonValue['db'];
										
										$('#dbtext1').val(dbObj['db2_primary_host']);			
										$('#dbtext2').val(dbObj['db2_standby_host']);			
																				
									}
									else if(objName=="mq")
									{
									
										var mqObj = jsonValue['mq'];
										var qpid_nodes = mqObj['qpid_nodes'];
										
										$('#mqtext1').val(qpid_nodes.substr(0,qpid_nodes.indexOf(",")));			
										$('#mqtext2').val(qpid_nodes.substr(qpid_nodes.indexOf(",")+1));										
									
									}
								}
								
							}
						
						}
						else if(jsonValue.type == "node-role-mapping")
						{
							loadedNodesObj[jsonValue['hostname']] =jsonValue;
							//console.log("node");
							var rows = $('#'+jsonValue['hostname']);						
							
							if(rows.length !=0)
							{
									var roleObj = jsonValue['role'];
								
									var roles=String(roleObj).split(",");
									//alert(roles);
									
									for (var j in roles) {
										//console.log('#'+jsonValue['hostname']+roles[j]+'');
										$('#'+jsonValue['hostname']+roles[j]+'').attr('checked', 'checked');										
									}										
							}	
							
						}
					}

		
					} } )

	}
		
		
	  function chooseNodeMappingOptions(){
	  
		// Check Network Type
		
		var network_type = $('#networktype').val();
		console.log("network_type : " + network_type);
						
		if(network_type=="quantum")
		{
			$('.Quantum').show();				
		}
		else
		{
			$('.Quantum').hide();	
		}		
		
		// Check Whether HA enabled or not
		
		var isHAEnabled = $('#haEnabledCheck:checked').val()?true:false;
		console.log("isHAEnabled : " + isHAEnabled);
		if(isHAEnabled)
		{
			$('.loadBalancer').show();	
			$('#deploymentSelection').hide();	
			showNodeMappingTable("HA","all-"+network_type);			
			console.log("showNodeMappingTable with HA All : " );
		}
		else
		{
			$('.loadBalancer').hide();
			$('#deploymentSelection').show();	
			$("#NodeMappingTable").empty();
			
			var deploymentOption = $('#deploymentSelectionSelect').val();
			if(deploymentOption!="all")
			{
				showNodeMappingTable("NONHA",deploymentOption+"-"+network_type);
			}
			else
			{
				showNodeMappingTable("NONHA",deploymentOption);
			}			
			console.log("showNodeMappingTable with NoHA " );
		}	

		
	  }


	  
	  function showNodeMappingTable(hanonha,options) {
	 			
				
				var nodes = chef_roles.rows;
				var jsonObject = nodes[0];
				var jsonValue = jsonObject.value;
				var hanonhaObject = jsonValue[hanonha];
				var nonhaObject = hanonhaObject[options];	
				var all_keys = Object.keys(nonhaObject);
				
				var tableStr="";
				tableStr = tableStr.concat("<TH align=\"center\">");
				for (var j in all_keys) {
					var value = nonhaObject[all_keys[j]];
					tableStr = tableStr.concat("<TD align=\"center\" width=\"10%\">");
					tableStr = tableStr.concat(value);
					tableStr = tableStr.concat("</TD>");
				}
				tableStr = tableStr.concat("</TH>");
					
				//alert(tableStr);
				$("#NodeMappingTable").empty();
				$("#NodeMappingTable").append(tableStr);
				var tableStr="";
				
						var nodes = cloud_nodes.rows;

						for(i=0;i<nodes.length;i++)
						{
							var jsonObject = nodes[i];						
							tableStr = tableStr.concat("<TR id=\""+(jsonObject.key)+"\" align=\"center\">");
							tableStr = tableStr.concat("<TD align=\"center\" width=\"10%\">");
							tableStr = tableStr.concat(jsonObject.key);
							tableStr = tableStr.concat("</TD>");	

							for (var j in all_keys) {
								var value = nonhaObject[all_keys[j]];
								tableStr = tableStr.concat("<TD align=\"center\" width=\"20%\">");
								tableStr = tableStr.concat("<input id=\""+(jsonObject.key)+(value)+"\" name=\""+(jsonObject.key)+(value)+"\" value=\""+(value)+"\" type=\"checkbox\">");
								tableStr = tableStr.concat("</TD>");
							}
							tableStr = tableStr.concat("</TR>");			
						}	
						
						$("#NodeMappingTable").append(tableStr);
					 	  
	  }	  


function deleteNode(id,revID) {
 
var jsonPayload = {};
jsonPayload['_id']=id;
jsonPayload['_rev']=revID;
 
$.couch.db("devops").removeDoc(jsonPayload, {
     success: function(data) {
         if(data.ok)
		{
			alert("Node Deleted");
			//location.reload(true);
			$('#node' + id).remove();
		}
    },
    error: function(status) {
        console.log("Error in Delete Node : " + status);
    }
});

    }

	
function deleteCluster1(id,revID) {

var docs = [
    {
        _id: "8065ab7678ff8cea85461329ea08c960",
        _rev: "1-e13b674afb51e1b55fd4757fb50cf5d1"
    },
    {
        _id: "8065ab7678ff8cea85461329ea0a03c9",
        _rev: "1-e13b674afb51e1b55fd4757fb50cf5d1"
    }
];
$.couch.db("devops").bulkRemove({"docs": docs}, {
    success: function(data) {
        console.log(data);
    },
    error: function(status) {
        console.log(status);
    }
});

}	
	
function deleteCluster(id,revID) {

//var delCloudObj = [];
var jsonPayload = {};

console.log("here");

jsonPayload['_id']=id;
jsonPayload['_rev']=revID;
 
		$.couch.db("devops").removeDoc(jsonPayload, {
			success: function(data) {
				console.log("data : "+ data);

    },
    error: function(status) {
        console.log("Error in Cluster Delete : " + status);
    }
});
//delCloudObj.push(jsonPayload);

 
 $.couch.db("devops").view("data/by_clusterid", { key: id, success: function(data) {

	var nodes = data.rows;
	
	
	for(nodeI=0;nodeI<nodes.length;nodeI++)
	{
		var jsonObject = nodes[nodeI];
		//alert(jsonObject);
		var jsonValue = jsonObject.value;
		
		jsonPayload['_id']=jsonValue['_id'];
		jsonPayload['_rev']=jsonValue['_rev'];
		
		//delCloudObj.push({_id: jsonValue['_id'], _rev: jsonValue['_rev']});
		
		$.couch.db("devops").removeDoc(jsonPayload, {
			success: function(data) {
				console.log("data : "+ data);

    },
    error: function(status) {
        console.log("Error in removing cluster : " + status);
    }
});
		
	}
				alert("Cluster Deleted");
				$('#cluster' + id).remove();
				//loadClusterList();
	

 },
    error: function(status) {
        console.log("Error in data/by_clusterid : " + status);
    }
});

/*$.couch.db("devops").bulkRemove({"docs": delCloudObj}, {
     success: function(data) {
	 console.log("data : "+ data);
	alert("Cluster Deleted");
	$('#cluster' + id).remove();
	loadClusterList();
    },
    error: function(status) {
        alert(status);
    }
});*/

    }

	function createNode()
	{
		
	$("#baseTable > tbody").append("<tr align='center'><td><input name=\"name\" id=\"name\" type=\"text\"></td><td><input name=\"install_nic\" id=\"install_nic\"  type=\"text\"></td><td><input name=\"install_ip\" id=\"install_ip\" type=\"text\"></td><td><input name=\"install_gw\" id=\"install_gw\" type=\"text\"></td><td><input name=\"install_nmask\" id=\"install_nmask\" type=\"text\"></td><td><img id=\"addNode\" src=\"img/add.png\"/></a></td></tr>");
	
		$('#name').focus();
		
			$("#addNode").click(function(e){
			
			var jsonPayload = {};
			jsonPayload['type']='node';
			
			var rows = $('#create_node input:text');
			for(i=0;i<rows .length;i++)
			{
				jsonPayload[rows[i].name]=rows[i].value;
			}
			$.couch.db("devops").saveDoc(jsonPayload, {
				success: function(data) {
					if(data.ok)
					{
						alert("Node Saved");
						location.reload(true);
						// loadAllNodes();
						
						//$("#baseTable > tbody").append("<tr id='"+(jsonValue._id)+"' align='center'><td>"+(jsonObject.key)+"</td><td>"+(jsonValue.install_nic)+"</td><td>"+(jsonValue.install_ip)+"</td><td>"+(jsonValue.install_gw)+"</td><td>"+(jsonValue.install_nmask)+"</td><td><a id=\"aaaa\" href=\"javascript:deleteNode('"+(jsonValue._id)+"','"+(jsonValue._rev)+"');\">Delete</a></td></tr>");
					}
				},
				error: function(status) {
					console.log("Error in Creating Node : " + status);
				}
			});
		});			
	}
	
	function loadAllNodes()
	{
		
		
		$.couch.db("devops").view("node-query/all", {

			success: function(data) {
				
				
				//$("#baseTable").empty();
				var nodes = data.rows;
				for(i=0;i<nodes.length;i++)
				{
					var jsonObject = nodes[i];
					var jsonValue = jsonObject.value;
					
					//alert(jsonValue._id);
					
					if(i == nodes.length-1)
					{
						$("#baseTable > tbody").append("<tr id='node"+(jsonValue._id)+"' align='center'><td class=\"rounded-foot-left\">"+(jsonObject.key)+"</td><td>"+(jsonValue.install_nic)+"</td><td>"+(jsonValue.install_ip)+"</td><td>"+(jsonValue.install_gw)+"</td><td>"+(jsonValue.install_nmask)+"</td><td class=\"rounded-foot-right\"><a id=\"aaaa\" href=\"javascript:deleteNode('"+(jsonValue._id)+"','"+(jsonValue._rev)+"');\"><img src=\"img/delete.png\"/></a></td></tr>");						
					}
					else
					{
						$("#baseTable > tbody").append("<tr id='node"+(jsonValue._id)+"' align='center'><td>"+(jsonObject.key)+"</td><td>"+(jsonValue.install_nic)+"</td><td>"+(jsonValue.install_ip)+"</td><td>"+(jsonValue.install_gw)+"</td><td>"+(jsonValue.install_nmask)+"</td><td><a id=\"aaaa\" href=\"javascript:deleteNode('"+(jsonValue._id)+"','"+(jsonValue._rev)+"');\"><img src=\"img/delete.png\"/></a></td></tr>");						
					}

				}
			   
			},
			error: function(status) {
				console.log("Error in node-query/all : " + status);
			},
			reduce: false
		});	
	}

	function loadClusterList()
	{

		$.couch.db("devops").view("cluster-query/all", {
			success: function(data) {
			var nodes = data.rows;
				
			$('#existingNodeSelect').empty();
			//$("#baseTableCluster  > tbody").empty();		
	
			
			for(i=0;i<nodes.length;i++)
			{
				var jsonObject = nodes[i];
				var jsonValue = jsonObject.value;		
				$('#existingNodeSelect').append('<option value='+jsonValue._id+'>'+jsonValue.name+'</option>');
				
					if(i == nodes.length-1)
					{
						$("#baseTableCluster > tbody").append("<tr id='cluster"+(jsonValue._id)+"' align='center'><td class=\"rounded-foot-left\">"+(jsonObject.key)+"</td><td>"+(jsonValue.description)+"</td><td>"+(	jsonValue.user_name)+"</td><td class=\"rounded-foot-right\"><a id=\"aaaa\" href=\"javascript:deleteCluster('"+(jsonValue._id)+"','"+(jsonValue._rev)+"');\"><img src=\"img/delete.png\"/></a></td></tr>");
					}
					else
					{
						$("#baseTableCluster > tbody").append("<tr id='cluster"+(jsonValue._id)+"' align='center'><td>"+(jsonObject.key)+"</td><td>"+(jsonValue.description)+"</td><td>"+(	jsonValue.user_name)+"</td><td ><a id=\"aaaa\" href=\"javascript:deleteCluster('"+(jsonValue._id)+"','"+(jsonValue._rev)+"');\"><img src=\"img/delete.png\"/></a></td></tr>");						
					}
				
			}
			
			console.log("Loaded Cluster List");
			
			},
			error: function(status) {
				console.log("Error in Loaded Cluster List : " + status);
			},
			reduce: false
		});
	}
	
	function clearAll()
	{
		$("form").each(function() {
				console.log(this.id);
				if(this.id!="deployment")
				{
					$("#"+(this.id)+"").each(function() {
						this.reset();
					});			
				}	
		});
		
		// Clear Info Tab
		$("#selectOptionLabel").text("");		
		$('.newCluster').hide();
		$('.existingNode').hide();
		
		// Clearn Basic Configuration
		chooseNodeMappingOptions();
		
		// Clean HA Configuration
		var rows = $('#HAConfigurataion div');
		rows.each(function() {

			if(this.id)
			{
				$('#'+(this.id)).hide();	
			}
		
		});

		$('#loadBalancer').hide();
		$('#deploymentSelection').show();
		

		
	}
	
    </script> 
  
  
</head>

<body>
	<div
		class="ui-tabs ui-widget ui-widget-content ui-corner-all ui-tabs-vertical ui-helper-clearfix"
		id="tabs">
		<ul 
			class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
			<li><a class="ui-tabs-anchor" href="#tabs-1">Node Registration</a></li>
			<li><a class="ui-tabs-anchor" href="#tabs-2">Cluster List</a></li>
			<li><a class="ui-tabs-anchor" href="#tabs-3">Info</a></li>
			<li><a class="ui-tabs-anchor" href="#tabs-4">Basic Configuration</a></li>
			<li><a class="ui-tabs-anchor" href="#tabs-5">HA Configuration</a></li>
			<li><a class="ui-tabs-anchor" href="#tabs-6">Node Role Mapping</a></li>
			<li><a class="ui-tabs-anchor" href="#tabs-7">Deployment</a></li>
		</ul>

		<div class="ui-tabs-panel ui-widget-content ui-corner-bottom "  align="center" id="tabs-1">
			
			<h2>Node Registration</h2>
				<table border="0" width="70%">
						<tr id="baseTableHeader">
							<th scope="col" width="50%"><a href="javascript:createNode()">Create New Node</a></th>
						</tr>					
				</table>			
			
			<p></p>
		
			<form name="create_node" id="create_node" >
				<table id="baseTable" name="baseTable"  width="70%">
				
						<tr id="baseTableHeader">
							<th scope="col" class="rounded-left" width="20%">Node Name</th>
							<th scope="col" width="10%">Install NIC</th>
							<th scope="col" width="20%">Install IP</th>
							<th scope="col" width="20%">Install Gateway</th>
							<th scope="col" width="20%">Net Mask</th>
							<th scope="col" width="5%" class="rounded-right">Delete</th>
						</tr>																						
				</table>
			</form>

		</div>
		<div class="ui-tabs-panel ui-widget-content ui-corner-bottom"   align="center" id="tabs-2">
			
			<h2>Available Cluster List</h2>

			<p></p>
				<table id="baseTableCluster"  width="70%">
						<tr id="baseTableHeaderCluster">
							<th scope="col" width="20%" class="rounded-left">Cluster Name</th>
							<th scope="col" width="40%">Description</th>
							<th scope="col" width="20%">Username</th>
							<th scope="col" width="5%" class="rounded-right">Delete</th>
						</tr>					
				</table>
			
		</div>	
		<div class="ui-tabs-panel ui-widget-content ui-corner-bottom"   id="tabs-3">
			<h2>Info</h2>
			<form name="info_form" id="info_form">
				<table border="0" width="50%">
					<tbody>
						<tr>
							<td width="20%"><label> Select Option: </label></td>
							<td><input id="selectOption" name="selectOption" value="New"
								type="radio">&nbsp;Create New
								Cluster&nbsp;&nbsp;&nbsp;&nbsp;<input name="selectOption"
								value="Exiting" type="radio">&nbsp;Select Existing
								Cluster</td>
						</tr>
						<tr>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
						</tr>

						<tr>
							<td width="20%"><label id="selectOptionLabel"></label></td>
							<td>
								<div id="newCluster" class="newCluster">
									<table border="0" width="100%">
										<tbody>
											<tr>
												<td width="30%"><label> Cluster Name</label></td>
												<td><input name="name" id="name" type="text"/></td>
											</tr>
											<tr>
												<td id="subCategory"><label> Cluster
														Description: </label></td>
												<td><input name="description" type="text"/></td>
											</tr>

										</tbody>
									</table>
								</div>
								<div id="existingNode" class="existingNode">
									<table  border="0"
										width="100%">
										<tbody>
											<tr>
												<td><select name="existingNodeSelect"
													id="existingNodeSelect">
												</select></td>
											</tr>
										</tbody>
									</table>
								</div>

							</td>
						</tr>
						<tr>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
						</tr>

						<tr>
							<td><input id="1" class="nextButton" value="NEXT"
								type="button"></td>
							<td align="left">&nbsp; </td>
						</tr>
					</tbody>
				</table>
			</form>
			<p></p>		
		</div>
		<div class="ui-tabs-panel ui-widget-content ui-corner-bottom"   id="tabs-4">
			<h2>Basic Configuration</h2>
			<form name="basic_configuration" id="basic_configuration">
				<input name="featureCodeGroupID" value="FOD" type="hidden">

				<div id="basicConfiguration">
					<table>
						<tbody>
							<tr>
								<td id="featureCodeCategory"><label> Database Type:
								</label></td>
								<td><select name="dbtype" id="dbtype">
										<option value="mysql">MySQL</option>
										<option value="db2">DB2</option>
								</select></td>
							</tr>
							<tr>
								<td><label> AMQP Type: </label></td>
								<td><select name="mqtype" id="mqtype">
										<option value="qpid">QPID</option>
										<option value="rabbitmq">RabbitMQ</option>
								</select></td>
							</tr>
							<tr>
								<td><label> Network Type: </label></td>
								<td><select name="networktype" id="networktype">
										<option value="quantum">Quantum</option>
										<option value="nova-network">Nova-Network</option>
								</select></td>
							</tr>

						</tbody>
					</table>
				</div>


				<p></p>
				<div id="OSOPS">
					<table summary="Speadsheet" border="1" width="50%">
						<TR>
							<TD width="15%" ROWSPAN=3>OSOPS</TD>
							<TD width="25%">Public Network</TD>
							<TD><input name="pubnet" id="pubnet" type="text"></TD>
						</TR>
						<TR>
							<TD>Nova Network</TD>
							<TD><input name="novanet" id="novanet" type="text"></TD>
						</TR>
						<TR>
							<TD>Management Network</TD>
							<TD><input name="mgmtnet" id="mgmtnet" type="text"></TD>
						</TR>

					</TABLE>
				</div>

				<p></p>
				<table  summary="Speadsheet" border="1" width="50%">
					<TR>
						<TD width="15%">Glance</TD>
						<TD width="25%">Image Upload</TD>
						<TD><input id="image_upload" name="image_upload" value="true"
							type="radio">&nbsp;Yes&nbsp;&nbsp;&nbsp;&nbsp;<input
							name="image_upload" value="false" type="radio">&nbsp;No</TD>
					</TR>


				</TABLE>

				<div id="Quantum" class="Quantum">
					<p></p>
					<table summary="Speadsheet" border="1" width="50%">
						<TR>
							<TD width="15%" ROWSPAN=6>Quantum</TD>
							<TD width="25%">Tenant Network Type</TD>
							<TD><input name="tenant_network_type" id="tenant_network_type" type="text"></TD>
						</TR>
						<TR>
							<TD>Network VLAN Rang</TD>
							<TD><input name="network_vlan_range" id="network_vlan_range" type="text"></TD>
						</TR>
						<TR>
							<TD>Tunnel ID Range</TD>
							<TD><input name="tunnel_id_range" id="tunnel_id_range" type="text"></TD>
						</TR>
						<TR>
							<TD>Enable Tunneling</TD>
							<TD><input id="enableTuneling" name="enable_tunneling"
								value="true" type="radio">&nbsp;Yes&nbsp;&nbsp;&nbsp;&nbsp;<input
								name="enable_tunneling" value="false" type="radio">&nbsp;No</TD>
						</TR>
						<TR>
							<TD>Bridge Mapping NIC</TD>
							<TD><input name="bridge_mapping_nic" id="bridge_mapping_nic" type="text"></TD>
						</TR>
						<TR>
							<TD>Floating IP NIC</TD>
							<TD><input name="floating_if" id="floating_if" type="text"></TD>
						</TR>
					</TABLE>
				</div>

				<table border="0" width="50%">
					<tbody>

						<tr>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
						</tr>
						<tr>
							<td><input class="backButton" value="BACK" type="button"></td>
							<td align="right"><input class="nextButton" id="2"
								value="NEXT" type="button"></td>
						</tr>
					</tbody>
				</table>	
			</form>	
		</div>
		<div class="ui-tabs-panel ui-widget-content ui-corner-bottom"   id="tabs-5">

			
			<h2>HA Configuration</h2>
			<form name="ha_configuration" id="ha_configuration">

				<div id="haEnabled" class="haEnabled">
					<table border="0" width="50%">
						<tbody>
							<tr>
								<td width="28%"><label> HA Enabled: </label></td>
								<td><input id="haEnabledCheck" name="haEnabledCheck"
									value="Yes" type="checkbox"></td>
							</tr>
						</tbody>
					</table>

					<p></p>

					<div id="loadBalancer" class="loadBalancer">

						<p></p>
						<div id="HAConfigurataion" class="HAConfigurataion">
							<table border="1" width="100%">
								<TH align="center">
								<TD align="center" width="10%">DB</TD>
								<TD align="center" width="10%">MQ</TD>
								<TD align="center" width="10%">KeyStone</TD>
								<TD align="center" width="10%">Glance API</TD>
								<TD align="center" width="10%">Glance Registry</TD>
								<TD align="center" width="10%">Cinder API</TD>
								<TD align="center" width="10%">NOVA API</TD>
								<TD align="center" width="10%">EC2-API</TD>
								<TD align="center" width="10%">Qunatum Server</TD>
								</TH>
								<TR align="center">
									<TD align="center" width="10%">HA Component</TD>
									<TD align="center" width="10%"><input
										name="db" id="db" value="true" type="checkbox"></TD>
									<TD align="center" width="10%"><input
										name="mq" id="mq" value="true" type="checkbox"></TD>
									<TD align="center" width="10%"><input
										name="keystone" id="keystone" value="true" type="checkbox"></TD>
									<TD align="center" width="10%"><input
										name="glance_api" id="glance_api"  value="true" type="checkbox"></TD>
									<TD align="center" width="10%"><input
										name="glance_registry" id="glance_registry"  value="true" type="checkbox"></TD>
									<TD align="center" width="10%"><input
										name="cinder_api" id="cinder_api" value="true" type="checkbox"></TD>
									<TD align="center" width="10%"><input
										name="nova_api" id="nova_api"  value="true" type="checkbox"></TD>
									<TD align="center" width="10%"><input
										name="ec2_api" id="ec2_api"  value="true" type="checkbox"></TD>
									<TD align="center" width="10%"><input
										name="quantum_server" id="quantum_server"  value="true" type="checkbox"></TD>
								</TR>
								<TR align="center">
									<TD align="center" width="10%">Virtual IP</TD>
									<TD align="center" width="10%">
										<div id="rowdb">
											<label id="dbPrimaryHost"> DB2 Primary </label> <input
												id="dbtext1" name="dbtext1"
												type="text" size="12"> <label id="dbSecondaryHost">DB2
												Secondary </label><input id="dbtext2"
												name="dbtext2" type="text" size="12">
											<label id="dbVirtualIPL"> Virtual IP </label><input
												id="dbtext" name="dbtext" type="text" size="12">
										</div>
									</TD>
									<TD align="center" width="10%">
										<div id="rowmq">
											<label id="mqPrimaryHost"> QPID Primary </label><input
												id="mqtext1" name="mqtext1"
												type="text" size="12"><label id="mqSecondaryHost">QPID
												Secondary </label><input id="mqtext2"
												name="mqtext2" type="text" size="12"><label
												id="mqVirtualIPL"> Virtual IP </label><input
												id="mqtext" name="mqtext" type="text" size="12">
										</div>
									</TD>
									<TD align="center" width="10%"><div
											id="rowkeystone">
											<input name="keystonetext" id="keystonetext"
												type="text" size="12">
										</div></TD>
									<TD align="center" width="10%"><div
											id="rowglance_api">
											<input name="glance_apitext" id="glance_apitext"
												type="text" size="12">
										</div></TD>
									<TD align="center" width="10%"><div
											id="rowglance_registry">
											<input name="glance_registrytext" id="glance_registrytext"
												type="text" size="12">
										</div></TD>
									<TD align="center" width="10%"><div
											id="rowcinder_api">
											<input name="cinder_apitext" id="cinder_apitext"
												type="text" size="12">
										</div></TD>
									<TD align="center" width="10%" id><div
											id="rownova_api">
											<input name="nova_apitext" id="nova_apitext"
												type="text" size="12">
										</div></TD>
									<TD align="center" width="10%"><div
											id="rowec2_api">
											<input name="ec2_apitext" id="ec2_apitext"
												type="text" size="12">
										</div></TD>
									<TD align="center" width="10%" id=><div
											id="rowquantum_server">
											<input name="quantum_servertext" id="quantum_servertext"
												type="text" size="12">
										</div></TD>
								</TR>
							</TABLE>
						</div>




					</div>

					<table border="0" width="50%">
						<tbody>

							<tr>
								<td>&nbsp;</td>
								<td>&nbsp;</td>
							</tr>
							<tr>
								<td><input class="backButton" value="BACK" type="button"></td>
								<td align="right"><input class="nextButton" id="3"
									value="NEXT" type="button"></td>
							</tr>
						</tbody>
					</table>



				</div>
			</form>


		</div>	
		<div class="ui-tabs-panel ui-widget-content ui-corner-bottom"   id="tabs-6">
			<h2>Node Role Mapping</h2>
			<form name="node_role_mapping" id="node_role_mapping">
	
			<div id="deploymentSelection" class="deploymentSelection">
				<table border="0" width="70%">
					<tbody>
						<tr>
							<td width="20%"><label> Deployment Selection: </label></td>
							<td><select name="deploymentSelectionSelect" id="deploymentSelectionSelect">
									<option value="all">All In One</option>
									<option value="single">Singole-Controller</option>
									<option value="multi">Multi-Nodes</option>
							</select></td>
						</tr>
					</tbody>
				</table>
			</div>
				<p></p>
				<div id="NodeMapping" class="NodeMapping">
					<table border="1"  id="NodeMappingTable" class="NodeMappingTable">
					</TABLE>
				</div>



				<table border="0" width="50%">
					<tbody>

						<tr>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
						</tr>
						<tr>
							<td><input class="backButton" value="BACK" type="button"></td>
							<td align="right"><input class="nextButton" id="4"
								value="NEXT" type="button"></td>
						</tr>
					</tbody>
				</table>

				<p></p>

			</form>		
		</div>
		
		<div class="ui-tabs-panel ui-widget-content ui-corner-bottom"  align="center" id="tabs-7">
			<h2>Deployment</h2>
			<form name="deployment" id="deployment">
				<p></p>
				<table border="0" width="60%">
					<tbody>
						<tr>
							<th scope="col" width="50%"><input id="startDeployment"
								value="Start Deployment" type="button"></th>
							<th scope="col" width="50%"><input id="resetCluster"
								value="Reset Cluster" type="button"></th>
						</tr>
						<tr align="center">
							<td colspan="2"><textarea id="result" rows="21" cols="90"></textarea></td>
							<!--<div class="include-file">this is test</div>-->
						</tr>
					</tbody>
				</table>
				<p></p>
				<p></p>		
			</form>			
		</div>
		</div>
		
</body>
</html>
